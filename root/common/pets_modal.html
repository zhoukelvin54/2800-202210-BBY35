<!--modal button-->
<div id="add_pet_button">
    <button onclick="showModal()" id="add_pet">Add Pet</button>
</div>
<div id="add_pet_modal" hidden>
    
    <!--modal content-->
    <form id="pet_details_form">

        <fieldset class="form_panel">
            <legend>Pet Details <span class="cancel">&#10006;</span></legend>

            <div class="inline_form_group">
                <label for="pet_name">Name:</label>
                <input type="text" id="pet_name" required>
            </div>
            <div class="inline_form_group">
                <label>Sex:</label>
                <div class="radio_button">
                    <label class="radio_label" for="male">Male</label>
                    <input type="radio" value="M" id="male" name="pet_sex" required>
                    <label class="radio_label" for="female">Female</label>
                    <input type="radio" value="F" id="female" name="pet_sex">
                </div>
            </div>
            <div class="inline_form_group">
                <label for="pet_species">Species:</label>
                <input type="text" name="pet_species" id="pet_species" required>
            </div>
            <div class="form_group">
                <label for="pet_description">Description:</label>
                <textarea class="text_area" name="pet_description" id="pet_description" required></textarea>
            </div>
            <div class="form_group">
                <label for="upload_pet_picture">Upload Pet Picture:</label>
                <input type="file" name="upload_pet_picture" id="upload_pet_picture" required />
            </div>

            <input class="submit_button" type="submit" value="Submit" />
        </fieldset>
    </form>
</div>

<script id="add_pet_script">
    function showModal() {
        document.getElementById('add_pet_modal').style.display = 'block';
    }
    document.querySelector('.cancel').onclick = function hideModal() {
        document.getElementById('add_pet_modal').style.display = 'none';
    }

    const form = document.forms['pet_details_form'];

    form.addEventListener("submit", handleForm);

    function handleForm(e) {
        e.preventDefault();
        try {
            updatePetInfo();
            document.getElementById("add_pet_modal").style.display = "none";
        } catch (err) {
            document.getElementById("error_message").innerText = err;
            return;
        }
    }

    function getPetData() {
        let sexButtons = document.querySelectorAll('input[name="pet_sex"]');
        for (const sexButton of sexButtons) {
            if (sexButton.checked) {
                var selectedSex = sexButton.value;
                break;
            }
        }
        return {
            pet_name: form["pet_name"].value,
            pet_sex: selectedSex,
            pet_species: form["pet_species"].value,
            pet_description: form["pet_description"].value,
            pet_picture: form["upload_pet_picture"].files[0].name
        }
    }

    async function updatePetInfo() {
        let petData = getPetData();
        fetch("/update-pet", {
            method: "PUT",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                "name": petData.pet_name,
                "gender": petData.pet_sex,
                "species": petData.pet_species,
                "description": petData.pet_description,
                "photo_url": petData.pet_picture
            })
        }).then(async res => {
            if (res.status == 200) {
                let data = await res.text();
                console.log(data);
                if (data) {
                    let parsed = JSON.parse(data);
                    if (parsed.status == "failure") {
                        console.log("error");
                    } else {
                        console.log("success");
                        window.location.assign("/home");
                    }
                }
            }
        }).catch(err => {
            console.err(err);
        });
    }
</script>